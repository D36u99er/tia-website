# 触发条件：推送 main 分支或手动触发。
# 流程：检出仓库，执行 scripts/deploy_bwg.sh 将静态资源同步到 BWG。

name: Deploy TIA Site to BWG

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: bwg-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Rsync static site to BWG
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository (with Git LFS assets)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Ensure LFS objects are downloaded
        run: git lfs pull

      - name: Prepare deploy script
        run: chmod +x scripts/deploy_bwg.sh

      - name: Deploy via deploy_bwg.sh
        env:
          BWG_HOST: ${{ secrets.BWG_HOST }}
          BWG_USER: ${{ secrets.BWG_USER }}
          BWG_TARGET_DIR: ${{ secrets.BWG_TARGET_DIR }}
          BWG_SSH_KEY: ${{ secrets.BWG_SSH_KEY }}
          BWG_PORT: ${{ secrets.BWG_PORT }}
          BWG_RSYNC_EXCLUDE: ${{ secrets.BWG_RSYNC_EXCLUDE }}
        run: ./scripts/deploy_bwg.sh
